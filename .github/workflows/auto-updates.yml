name: Automated Updates

on:
  schedule:
    # Run weekly on Sunday at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:

jobs:
  update-changelog:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install git-changelog
      run: |
        python -m pip install --upgrade pip
        pip install git-changelog

    - name: Generate changelog
      run: |
        # Generate changelog from git history
        git changelog --output CHANGELOG.md --bump latest

    - name: Check for changes
      id: verify-changed-files
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
        else
          echo "changed=false" >> $GITHUB_OUTPUT
        fi

    - name: Create Pull Request
      if: steps.verify-changed-files.outputs.changed == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "docs: update changelog"
        title: "üìù Update Changelog"
        body: |
          ## Changes
          - Updated CHANGELOG.md with latest changes

          ## Type of Change
          - [ ] Bug fix
          - [ ] New feature
          - [ ] Breaking change
          - [x] Documentation update
          - [ ] Other

          Auto-generated by [create-pull-request][1]

          [1]: https://github.com/peter-evans/create-pull-request
        branch: automated/changelog-update
        delete-branch: true

  update-toc:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install markdown-toc
      run: npm install -g markdown-toc

    - name: Update table of contents
      run: |
        ./scripts/generate_toc.sh --all

    - name: Check for changes
      id: verify-changed-files
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
        else
          echo "changed=false" >> $GITHUB_OUTPUT
        fi

    - name: Create Pull Request
      if: steps.verify-changed-files.outputs.changed == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "docs: update table of contents"
        title: "üìö Update Table of Contents"
        body: |
          ## Changes
          - Updated table of contents in documentation files

          ## Type of Change
          - [ ] Bug fix
          - [ ] New feature
          - [ ] Breaking change
          - [x] Documentation update
          - [ ] Other

          Auto-generated by [create-pull-request][1]

          [1]: https://github.com/peter-evans/create-pull-request
        branch: automated/toc-update
        delete-branch: true

  dependency-updates:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Update Python dependencies
      run: |
        # Check if there are Python requirements files
        if [ -f "requirements.txt" ] || [ -f "pyproject.toml" ]; then
          echo "Updating Python dependencies..."
          pip install --upgrade pip-tools
          if [ -f "requirements.in" ]; then
            pip-compile --upgrade requirements.in
          elif [ -f "pyproject.toml" ]; then
            # For pyproject.toml, we'd need additional tools
            echo "pyproject.toml found - manual update may be needed"
          fi
        else
          echo "No Python dependency files found"
        fi

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Update Node.js dependencies
      run: |
        # Check for package.json files
        if find . -name "package.json" -not -path "./node_modules/*" | grep -q .; then
          echo "Updating Node.js dependencies..."
          npm install -g npm-check-updates
          find . -name "package.json" -not -path "./node_modules/*" -exec ncu -u {} \;
        else
          echo "No package.json files found"
        fi

    - name: Check for changes
      id: verify-changed-files
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
        else
          echo "changed=false" >> $GITHUB_OUTPUT
        fi

    - name: Create Pull Request
      if: steps.verify-changed-files.outputs.changed == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "build: update dependencies"
        title: "‚¨ÜÔ∏è Update Dependencies"
        body: |
          ## Changes
          - Updated project dependencies to latest versions

          ## Type of Change
          - [ ] Bug fix
          - [ ] New feature
          - [ ] Breaking change
          - [ ] Documentation update
          - [x] Dependency update
          - [ ] Other

          ## Testing
          - [ ] All tests pass
          - [ ] No breaking changes detected

          Auto-generated by [create-pull-request][1]

          [1]: https://github.com/peter-evans/create-pull-request
        branch: automated/dependency-updates
        delete-branch: true
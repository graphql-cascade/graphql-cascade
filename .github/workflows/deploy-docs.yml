name: Deploy Documentation

on:
  push:
    branches: [ main ]
    paths:
      - 'docs/**'
      - 'specification/**'
      - 'README.md'
      - 'CONTRIBUTING.md'
      - 'CHANGELOG.md'
      - '.github/workflows/deploy-docs.yml'
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Pages
      uses: actions/configure-pages@v4
      with:
        enablement: true
      continue-on-error: true

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install MkDocs and dependencies
      run: |
        python -m pip install --upgrade pip
        pip install mkdocs mkdocs-material mkdocs-macros-plugin

    - name: Create mkdocs.yml configuration
      run: |
        cat > mkdocs.yml << 'EOF'
        site_name: GraphQL Cascade
        site_description: Cascading cache updates for GraphQL
        site_author: GraphQL Cascade Team
        site_url: https://graphql-cascade.github.io/

        theme:
          name: material
          palette:
            - media: "(prefers-color-scheme)"
              toggle:
                icon: material/brightness-auto
                name: Switch to light mode
            - media: "(prefers-color-scheme: light)"
              scheme: default
              primary: blue
              accent: blue
              toggle:
                icon: material/brightness-7
                name: Switch to dark mode
            - media: "(prefers-color-scheme: dark)"
              scheme: slate
              primary: blue
              accent: blue
              toggle:
                icon: material/brightness-4
                name: Switch to system preference
          features:
            - navigation.tabs
            - navigation.sections
            - toc.integrate
            - search.suggest
            - search.highlight
            - content.tabs.link
            - content.code.annotation
            - content.code.copy

        plugins:
          - search
          - macros

        markdown_extensions:
          - pymdownx.highlight:
              anchor_linenums: true
          - pymdownx.inlinehilite
          - pymdownx.snippets
          - pymdownx.superfences
          - pymdownx.tabbed:
              alternate_style: true
          - pymdownx.emoji:
              emoji_index: !!python/name:materialx.emoji.twemoji
              emoji_generator: !!python/name:materialx.emoji.to_svg
          - toc:
              permalink: true
          - pymdownx.arithmatex:
              generic: true
          - footnotes
          - admonition
          - pymdownx.details
          - pymdownx.superfences
          - pymdownx.mark
          - attr_list
          - md_in_html

        nav:
          - Home: index.md
          - Getting Started:
              - Quick Start: docs/getting-started/quick-start.md
              - Concepts: docs/getting-started/concepts.md
              - First Cascade: docs/getting-started/first-cascade.md
          - Specification:
              - Overview: specification/README.md
              - Introduction: specification/00_introduction.md
              - Conformance: specification/01_conformance.md
              - Cascade Model: specification/02_cascade_model.md
              - Entity Identification: specification/03_entity_identification.md
              - Mutation Responses: specification/04_mutation_responses.md
              - Invalidation: specification/05_invalidation.md
              - Subscriptions: specification/06_subscriptions.md
              - Schema Conventions: specification/07_schema_conventions.md
              - Directives: specification/08_directives.md
              - Server Requirements: specification/09_server_requirements.md
              - Tracking Algorithm: specification/10_tracking_algorithm.md
              - Invalidation Algorithm: specification/11_invalidation_algorithm.md
              - Performance Requirements: specification/12_performance_requirements.md
              - Client Integration: specification/13_client_integration.md
              - Optimistic Updates: specification/14_optimistic_updates.md
              - Conflict Resolution: specification/15_conflict_resolution.md
              - Security: specification/16_security.md
              - Performance: specification/17_performance.md
              - Appendices: specification/appendices/
          - Guides:
              - Server Implementation: docs/guides/server-implementation.md
              - Client Integration: docs/guides/client-integration.md
              - Apollo Integration: docs/guides/apollo-integration.md
              - Relay Integration: docs/guides/relay-integration.md
              - Testing: docs/guides/testing.md
              - Debugging: docs/guides/debugging.md
              - Migration: docs/guides/migration.md
          - API Reference:
              - Server API: docs/api/server-api.md
              - Client API: docs/api/client-api.md
              - Directives: docs/api/directives.md
          - Examples:
              - Overview: examples/README.md
              - Todo App: examples/todo-app/README.md
              - Blog Platform: examples/blog-platform/README.md
              - Real-time Collaboration: examples/real-time-collab/README.md
              - E-commerce: examples/e-commerce/README.md
          - Architecture: docs/architecture/
          - Contributing: CONTRIBUTING.md
          - Changelog: CHANGELOG.md

        extra:
          version:
            provider: mike
          social:
            - icon: fontawesome/brands/github
              link: https://github.com/graphql-cascade/graphql-cascade
            - icon: fontawesome/brands/discord
              link: https://discord.gg/graphql-cascade

        extra_css:
          - stylesheets/extra.css
        EOF

    - name: Create docs structure for MkDocs
      run: |
        mkdir -p docs_site

        # Copy README as index
        cp README.md docs_site/index.md

        # Copy docs directories
        cp -r docs/* docs_site/ 2>/dev/null || true
        cp -r specification docs_site/ 2>/dev/null || true
        cp -r examples docs_site/ 2>/dev/null || true

        # Create stylesheets directory
        mkdir -p docs_site/stylesheets
        cat > docs_site/stylesheets/extra.css << 'EOF'
        .md-header__topic {
          font-weight: 700;
        }

        .md-nav__link--active {
          font-weight: 600;
        }

        /* Custom styles for GraphQL Cascade */
        .cascade-highlight {
          background-color: #e3f2fd;
          padding: 1rem;
          border-left: 4px solid #2196f3;
          margin: 1rem 0;
        }

        .dark .cascade-highlight {
          background-color: #1a237e;
          border-left-color: #64b5f6;
        }
        EOF

    - name: Build with MkDocs
      run: mkdocs build --site-dir ./site

    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./site

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        continue-on-error: true